<html>
	<head>
		<title>Smokin' Graphs</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="Chart.js"></script>
		<meta name = "viewport" content = "initial-scale = 1, user-scalable = no">
	</head>
	<body>
		<h2>Temperature graphs</h2>
		<canvas id="tcCanvas" height="450" width="600">Please get a modern browser, if you had one, the smoker temperature would be graphed here.</canvas>
		<canvas id="fanCanvas" height="450" width="600">Ditto, but this is the fan speed.</canvas>
		<script type="text/javascript">
		var tcArray = [];
		var fanArray = [];
		var spArray = [];
		var lblArray = [];
		var count = 0;
		var tcctx = document.getElementById('tcCanvas').getContext('2d');
		var fanctx = document.getElementById('fanCanvas').getContext('2d');
		var records = 90;

		function init(){
				updateArrays();
				draw();
				setInterval(draw,1000);
				setInterval(updateArrays,1000);
		}

		function variableURL(variablename){
			var device = "48ff6b065067555023151787";
			var access_token = "1451c88ec0c225eb59e8474d3b986c595ca3d111";
			return "https://api.spark.io/v1/devices/".concat( device, "/", variablename, "?access_token=", access_token);
		}

		function updateArrays(){
			$.getJSON(variableURL("tctemp"),function(result){
				tcArray.push(result["result"]);
				if (count % 10 == 0){
					var d = new Date();
					lblArray.push(d.toLocaleTimeString());
				} else {
					lblArray.push("");
				}
				count++;
			});

			$.getJSON(variableURL("output"),function(result){
				fanArray.push(result["result"]/255 * 100);
			});

			$.getJSON(variableURL("setpoint"),function(result){
				spArray.push(result["result"]);
			});

			if (lblArray.length > records && tcArray.length > records && fanArray.length > records && spArray.length > records)
			{
				lblArray.shift();
				tcArray.shift();
				fanArray.shift();
				spArray.shift();
			}

		}
		function draw(){
			var lineChartData = {
				labels : lblArray,
				datasets : [
					{
						fillColor : "rgba(191,84,46,0.5)",
						strokeColor : "rgba(191,84,46,1)",
						pointColor : "rgba(191,84,46,1)",
						pointStrokeColor : "#fff",
						animation : false,
						bezierCurve : false,
						data : tcArray
					},
					{
						strokeColor : "rgba(0,0,0,1)",
						data : spArray
					}

				]
				
			}
			var fanChartData = {
				labels : lblArray,
				datasets : [
					{
						fillColor : "rgba(151,187,205,0.5)",
						strokeColor : "rgba(151,187,205,1)",
						pointColor : "rgba(151,187,205,1)",
						pointStrokeColor : "#fff",
						data : fanArray
					}
				]
			}

			var chartoptions = {
				animation : false,
				bezierCurve : false,
				datasetFill : false,
				pointDot : false
				}
				

			var myLine = new Chart(tcctx).Line(lineChartData, chartoptions);
			var fanLine = new Chart(fanctx).Line(fanChartData, chartoptions);
			
		}

		init();
		</script>
	</body>
</html>
